<!DOCTYPE html>
<html lang="en"> <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <title>eBuds - Wallet</title> <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    /* Stilurile pentru scrollbar rƒÉm√¢n neschimbate */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background: hsl(var(--dark-bg, #030014));
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: hsl(var(--neon-green, #00ff9d));
      border-radius: 10px;
      border: 3px solid hsl(var(--dark-bg, #030014));
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: hsl(var(--highlight-color, #00ff9d));
      filter: brightness(1.2);
    }

    html {
      scrollbar-width: thin;
      scrollbar-color: hsl(var(--neon-green, #00ff9d)) hsl(var(--dark-bg, #030014));
    }

    .warning-icon {
        color: #ffcc00;
        cursor: help;
        font-style: normal;
    }

    /* Price display styles */
    .price-info {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        font-size: 0.9em;
        color: #888;
    }

    .price-usd {
        color: #00ff9d;
        font-weight: 500;
    }

    .price-change {
        font-size: 0.8em;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        margin-top: 2px;
    }

    .price-change.positive {
        color: #4caf50;
        background-color: rgba(76, 175, 80, 0.1);
    }

    .price-change.negative {
        color: #f44336;
        background-color: rgba(244, 67, 54, 0.1);
    }

    .price-loading {
        color: #666;
        font-style: italic;
    }

    .price-error {
        color: #888;
        font-size: 0.8em;
    }

    .asset-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .asset-details {
        flex: 1;
    }

    .total-value {
        background: linear-gradient(135deg, rgba(0, 255, 157, 0.1), rgba(0, 255, 157, 0.05));
        border: 1px solid rgba(0, 255, 157, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        text-align: center;
    }

    .total-value h3 {
        margin: 0 0 10px 0;
        color: #00ff9d;
        font-size: 1.2em;
    }

    .total-value .amount {
        font-size: 1.5em;
        font-weight: bold;
        color: #fff;
    }
  </style>
</head>
<body>
  <div class="background-overlay"></div>
  <nav class="wallet-nav">
    <div class="wallet-nav-container">
        <a href="index.html" class="logo-link">
            <img src="assets/logo.png" alt="eBuds Logo" class="nav-logo-wallet">
        </a>
        <div class="nav-title-group">
            <h1 class="wallet-nav-title" data-translate-key="wallet_page_title">eBuds Wallet</h1>
        </div>
        <div class="nav-right-controls"> <div class="language-selector-container">
                <select id="language-selector-wallet" aria-label="Select Language">
                    <option value="en">EN</option>
                    <option value="ar">AR</option> 
                    <option value="zh">ZH</option> 
                    <option value="de">DE</option> 
                    <option value="es">ES</option> 
                    <option value="fr">FR</option> 
                    <option value="it">IT</option> 
                    <option value="ja">JA</option> 
                    <option value="ko">KO</option> 
                    <option value="ro">RO</option> 
                </select>
            </div>
            <button id="disconnectBtnNav" class="button-connect-wallet disconnect-button" data-translate-key="disconnect_button" style="display:none; margin-left: 10px;"></button>
        </div>
    </div>
  </nav>

  <div class="container-wrapper">
    <div class="main-content-area">
      <h1 data-translate-key="connect_info_title">Your Web3 Universe</h1>
      <div id="connectionOptions" style="display: block;">
        <!-- Container pentru mesaje de stare generale/de initializare -->
        <div class="status-container" data-status-for="general"></div>
        <div class="wallet-options-grid">
          <div class="wallet-option">
            <h3 data-translate-key="xportal_mobile_title">üì± xPortal (Mobile)</h3>
            <p data-translate-key="xportal_mobile_description">Connect via the mobile application.</p>
            <div id="qr-code-container" style="margin: 10px auto; max-width: 250px;"></div>
            <div class="status-container" data-status-for="mobile"></div>
            <button id="mobileBtn" class="button-connect-wallet" data-translate-key="generate_qr_button">Generate QR</button>
          </div>
          <div class="wallet-option" id="extensionWalletOption">
            <h3 data-translate-key="browser_extension_title">üîå Browser Extension</h3>
            <p data-translate-key="browser_extension_description">Use the MultiversX browser extension.</p>
            <div class="status-container" data-status-for="extension"></div>
            <button id="extensionBtn" class="button-connect-wallet" data-translate-key="connect_extension_button">Connect Extension</button>
          </div>
        </div>

        <div class="wallet-option manual-option">
          <h3 data-translate-key="view_address_title">üëÅÔ∏è View Address</h3>
          <p data-translate-key="view_address_description">Manually enter wallet address to view assets.</p>
          <div class="manual-input">
            <input type="text" id="manualAddressInput" placeholder="erd1..." />
            <button id="manualAddressBtn" class="button-connect-wallet" data-translate-key="check_address_button">Check Address</button>
          </div>
          <div class="status-container" data-status-for="manual"></div>
        </div>
      </div>

      <div id="walletUI" style="display: none;">
        <div class="status-container" data-status-for="wallet-load"></div>
        <div id="walletDetails" class="wallet-info-container"></div>
      </div>

      <div class="back-link-container">
        <a href="index.html" class="back-link" data-translate-key="back_to_main_site">‚Üê Back to Main Site</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { ElvenJS } from 'https://unpkg.com/elven.js@0.20.0/build/elven.js';

    const translations = {
        en: {
            wallet_page_title: "eBuds Wallet",
            connect_info_title: "Your Web3 Universe",
            xportal_mobile_title: "üì± xPortal (Mobile)",
            xportal_mobile_description: "Connect via the mobile application.",
            generate_qr_button: "Generate QR",
            browser_extension_title: "üîå Browser Extension",
            browser_extension_description: "Use the MultiversX browser extension.",
            connect_extension_button: "Connect Extension",
            view_address_title: "üëÅÔ∏è View Address",
            view_address_description: "Manually enter wallet address to view assets.",
            check_address_button: "Check Address",
            disconnect_button: "Disconnect",
            back_button: "Back",
            back_to_main_site: "‚Üê Back to Main Site",
            wallet_info_title: "Wallet Information",
            address_label: "Address:",
            egld_balance_label: "EGLD Balance:",
            vote_power_label: "Voting Power:",
            vote_power_desc: "(based on number of eBuds NFTs held)",
            assets_title: "Assets in Wallet",
            tokens_section_title: "ü™ô Tokens",
            nfts_section_title: "üñºÔ∏è NFT Collections",
            no_tokens_message: "You don't hold any tokens (excluding EGLD).",
            no_other_nfts_message: "You don't hold any other NFT collections.",
            loading_wallet_data: "Loading wallet data...",
            invalid_address: "Invalid wallet address",
            blockchain_error: "Error fetching data from blockchain",
            elven_init_error: "Error initializing ElvenJS",
            generating_qr: "Generating QR code...",
            qr_error: "Error generating QR code",
            connecting_extension: "Attempting to connect extension...",
            extension_error: "Error connecting extension",
            disconnecting: "Disconnecting...",
            disconnect_error: "Error disconnecting",
            invalid_manual_address: "The entered address is invalid.",
            connecting_init: "Initializing connection...",
            ebud_token_label: " Token EBUD",
            luv_token_label: "LUV Token",
            green_token_label: "GREEN Token",
            hit_token_label: "HIT Token",
            bud_collection_label: "eBuds Collection",
            total_portfolio_value: "Total Portfolio Value",
            loading_prices: "Loading prices...",
            price_unavailable: "Price unavailable",
        },
        ro: {
            wallet_page_title: "Portofel eBuds",
            connect_info_title: "Universul tƒÉu Web3",
            xportal_mobile_title: "üì± xPortal (Mobil)",
            xportal_mobile_description: "ConecteazƒÉ-te prin aplica»õia mobilƒÉ.",
            generate_qr_button: "GenereazƒÉ QR",
            browser_extension_title: "üîå Extensie Browser",
            browser_extension_description: "Folose»ôte extensia de browser MultiversX.",
            connect_extension_button: "ConecteazƒÉ Extensia",
            view_address_title: "üëÅÔ∏è Vizualizare AdresƒÉ",
            view_address_description: "Introdu manual adresa portofelului pentru a vizualiza activele.",
            check_address_button: "VerificƒÉ Adresa",
            disconnect_button: "Deconectare",
            back_button: "√énapoi",
            back_to_main_site: "‚Üê √énapoi la Site-ul Principal",
            wallet_info_title: "Informa»õii Portofel",
            address_label: "AdresƒÉ:",
            egld_balance_label: "Sold EGLD:",
            vote_power_label: "Putere de Vot:",
            vote_power_desc: "(bazatƒÉ pe numƒÉrul de eBuds NFTs de»õinute)",
            assets_title: "Active √Æn Portofel",
            tokens_section_title: "ü™ô Tokeni",
            nfts_section_title: "üñºÔ∏è Colec»õii NFT",
            no_tokens_message: "Nu de»õine»õi tokeni (excluz√¢nd EGLD).",
            no_other_nfts_message: "Nu de»õine»õi alte colec»õii NFT.",
            loading_wallet_data: "Se √ÆncarcƒÉ datele portofelului...",
            invalid_address: "AdresƒÉ portofel invalidƒÉ",
            blockchain_error: "Eroare la ob»õinerea datelor de pe blockchain",
            elven_init_error: "Eroare la ini»õializarea ElvenJS",
            generating_qr: "Se genereazƒÉ codul QR...",
            qr_error: "Eroare la generarea codului QR",
            connecting_extension: "Se √ÆncearcƒÉ conectarea extensiei...",
            extension_error: "Eroare la conectarea extensiei",
            disconnecting: "Se deconecteazƒÉ...",
            disconnect_error: "Eroare la deconectare",
            invalid_manual_address: "Adresa introdusƒÉ nu este validƒÉ.",
            connecting_init: "Se ini»õiazƒÉ conectarea...",
            ebud_token_label: "Token EBUD",
            luv_token_label: "Token LUV",
            green_token_label: "Token GREEN",
            hit_token_label: "Token HIT",
            bud_collection_label: "Colec»õia eBuds",
            total_portfolio_value: "Valoarea TotalƒÉ a Portofoliului",
            loading_prices: "Se √ÆncarcƒÉ pre»õurile...",
            price_unavailable: "Pre»õ indisponibil",
        },
    };

    // Price fetching functionality
    const priceCache = new Map();
    const PRICE_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    const tokenIdMapping = {
        'EGLD': 'multiversx-egld',
        'EBUD-d29cce': 'ebuds',
        'LUV-310136': 'luv-token',
        'GREEN-1c62ca': 'green-token',
        'HIT-3f109b': 'hit-token'
    };

    const fetchTokenPrices = async (tokenIds) => {
        const now = Date.now();
        const tokensToFetch = [];
        const cachedPrices = {};

        // Check cache first
        for (const tokenId of tokenIds) {
            const cacheKey = tokenIdMapping[tokenId] || tokenId.toLowerCase();
            const cached = priceCache.get(cacheKey);
            
            if (cached && (now - cached.timestamp) < PRICE_CACHE_DURATION) {
                cachedPrices[tokenId] = cached.data;
            } else {
                tokensToFetch.push(cacheKey);
            }
        }

        // Fetch missing prices
        if (tokensToFetch.length > 0) {
            try {
                // Use CoinGecko API with fallback to a proxy if needed
                const apiUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${tokensToFetch.join(',')}&vs_currencies=usd&include_24hr_change=true`;
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Cache the results
                Object.entries(data).forEach(([coinId, priceData]) => {
                    priceCache.set(coinId, {
                        data: priceData,
                        timestamp: now
                    });
                    
                    // Map back to token ID
                    const tokenId = Object.keys(tokenIdMapping).find(key => tokenIdMapping[key] === coinId) || coinId;
                    cachedPrices[tokenId] = priceData;
                });
                
            } catch (error) {
                console.warn('Failed to fetch prices from CoinGecko:', error);
                // Return empty prices for failed fetches
                tokensToFetch.forEach(coinId => {
                    const tokenId = Object.keys(tokenIdMapping).find(key => tokenIdMapping[key] === coinId) || coinId;
                    cachedPrices[tokenId] = null;
                });
            }
        }

        return cachedPrices;
    };

    const formatPrice = (price) => {
        if (price === null || price === undefined) return null;
        
        if (price < 0.01) {
            return price.toFixed(6);
        } else if (price < 1) {
            return price.toFixed(4);
        } else {
            return price.toFixed(2);
        }
    };

    const formatPriceChange = (change) => {
        if (change === null || change === undefined) return null;
        
        const formatted = Math.abs(change).toFixed(2);
        return change >= 0 ? `+${formatted}%` : `-${formatted}%`;
    };

    function translatePage(language) {
        document.documentElement.lang = language;
        const translatableElements = document.querySelectorAll('[data-translate-key]');
        translatableElements.forEach(element => {
            const key = element.getAttribute('data-translate-key');
            if (translations[language] && translations[language][key]) {
                element.innerHTML = translations[language][key];
            } else if (translations.en && translations.en[key]) {
                 element.innerHTML = translations.en[key];
            }
        });
        const pageTitleElement = document.querySelector('head title');
        if (pageTitleElement) {
            pageTitleElement.textContent = translations[language]?.['wallet_page_title'] || translations.en['wallet_page_title'];
        }
    }


    document.addEventListener("DOMContentLoaded", async () => {
      const connectionOptions = document.getElementById('connectionOptions');
      const walletUI = document.getElementById('walletUI');
      const walletDetails = document.getElementById('walletDetails');
      const manualAddressInput = document.getElementById('manualAddressInput');
      const languageSelector = document.getElementById('language-selector-wallet');
      
      const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
      const restApiBase = 'https://api.multiversx.com';
      
      const ebudsCollectionId = 'BUD-3ee0cf';
      let isManualConnection = false;
      let loginTarget = 'general';

      if (languageSelector) {
        translatePage(languageSelector.value);
        languageSelector.addEventListener('change', async (event) => {
            translatePage(event.target.value);
            const rawAddress = ElvenJS.storage.get('address');
            const addressString = typeof rawAddress === 'object' && rawAddress?.address
                                 ? rawAddress.address
                                 : (typeof rawAddress === 'string' ? rawAddress : '');
            if (addressString.startsWith('erd1') && addressString.length === 62) {
                await fetchWalletData(addressString);
            }
        });
      } else {
        translatePage('en');
      }

      const hideStatus = () => {
        document.querySelectorAll('.status-container').forEach(container => {
            container.innerHTML = '';
        });
      };

      const showStatus = (targetType, messageKey, type = 'loading', errorDetails = '') => {
        hideStatus();

        const targetContainer = document.querySelector(`.status-container[data-status-for="${targetType}"]`);
        if (!targetContainer) {
            console.error(`Status container for "${targetType}" not found.`);
            return;
        }

        const currentLang = languageSelector ? languageSelector.value : 'en';
        let message = (translations[currentLang]?.[messageKey] || translations.en[messageKey] || messageKey).toString();
        if (type === 'error' && errorDetails) {
            message += `: ${errorDetails}`;
        }

        const statusDiv = document.createElement('div');
        statusDiv.className = `status-message status-${type}`;
        statusDiv.textContent = message;
        targetContainer.appendChild(statusDiv);
      };
      
      const resolveIpfsUrl = (originalUrl) => {
        if (!originalUrl || typeof originalUrl !== 'string') return '';
        
        const reliableGateway = 'https://dweb.link/ipfs/';

        if (originalUrl.startsWith('ipfs://')) {
            const ipfsHash = originalUrl.replace('ipfs://', '');
            return `${reliableGateway}${ipfsHash}`;
        }
        
        if (originalUrl.includes('tools.multiversx.com') || originalUrl.includes('media.elrond.com')) {
            return originalUrl;
        }

        const ipfsPattern = /\/ipfs\/(Qm[1-9A-Za-z]{44}|bafy[0-9a-zA-Z]{50,})/;
        const match = originalUrl.match(ipfsPattern);

        if (match && match[1]) {
            const ipfsHash = match[1];
            return `${reliableGateway}${ipfsHash}`;
        }

        if (originalUrl.match(/^(Qm[1-9A-Za-z]{44}|bafy[0-9a-zA-Z]{50,})$/)) {
            return `${reliableGateway}${originalUrl}`;
        }

        if (originalUrl.startsWith('http')) {
            return originalUrl;
        }

        return ''; 
      };

    const truncateAddress = (address) => {
        if (!address || address.length < 12) return address;
        return `${address.substring(0, 7)}...${address.substring(address.length - 5)}`;
    };

    const displayData = async (address, nfts, tokens, accountData) => {
        const votePower = nfts.filter(nft => nft.collection === ebudsCollectionId).length;
        const currentLang = languageSelector ? languageSelector.value : 'en';
        const t = translations[currentLang] || translations.en;
        
        const truncatedAddr = truncateAddress(address);
        
        const egldBalanceValue = accountData && accountData.balance ? (parseFloat(accountData.balance) / (10 ** 18)).toFixed(4) : (0).toFixed(4);

        let html = `
          <h2>${t.wallet_info_title}</h2>
          <p><strong>${t.address_label}</strong> <a href="https://explorer.multiversx.com/accounts/${address}" target="_blank" rel="noopener noreferrer" title="${address}">${truncatedAddr} ‚Üó</a></p>
          <p><strong>${t.egld_balance_label}</strong> ${egldBalanceValue} EGLD</p> 
          <div class="vote-power-card">
            <strong>üèÜ ${t.vote_power_label} ${votePower}</strong>
            <br><small>${t.vote_power_desc}</small>
          </div>
        `;

        html += `<div class="assets-title">${t.assets_title}</div><div class="assets-grid">`;

        const allTokensForDisplay = [];
        const fixedTokensOrder = ['EGLD', 'EBUD-d29cce', 'LUV-310136', 'GREEN-1c62ca', 'HIT-3f109b'];

        // Add EGLD first
        allTokensForDisplay.push({
            identifier: 'EGLD',
            name: 'MultiversX',
            balance: accountData.balance || '0',
            decimals: 18,
            assets: {
                svgUrl: 'https://tools.multiversx.com/assets-cdn/tokens/EGLD/icon.svg'
            },
            iconType: 'native'
        });

        fixedTokensOrder.slice(1).forEach(fixedId => {
            let tokenInfo = tokens.find(t => t.identifier === fixedId);
            
            if (fixedId === 'EBUD-d29cce') {
                allTokensForDisplay.push({
                    identifier: fixedId,
                    name: t.ebud_token_label,
                    balance: tokenInfo ? tokenInfo.balance : '0',
                    decimals: tokenInfo ? tokenInfo.decimals : 0,
                    assets: {
                        svgUrl: 'https://tools.multiversx.com/assets-cdn/tokens/EBUD-d29cce/icon.svg'
                    },
                    iconType: 'home'
                });
            } else if (tokenInfo) {
                allTokensForDisplay.push({
                    identifier: fixedId,
                    name: fixedId === 'LUV-310136' ? t.luv_token_label : (fixedId === 'GREEN-1c62ca' ? t.green_token_label : t.hit_token_label),
                    balance: tokenInfo.balance,
                    decimals: tokenInfo.decimals,
                    assets: tokenInfo.assets,
                    iconType: 'favorite'
                });
            }
        });

        const remainingTokens = tokens.filter(token =>
            token.identifier !== 'EGLD' && !fixedTokensOrder.includes(token.identifier) && parseFloat(token.balance) / (10 ** (token.decimals || 0)) > 0
        ).sort((a, b) => (a.name || a.identifier).localeCompare(b.name || b.identifier));

        remainingTokens.forEach(token => allTokensForDisplay.push(token));

        // Fetch prices for all tokens
        const tokenIds = allTokensForDisplay.map(token => token.identifier);
        const prices = await fetchTokenPrices(tokenIds);

        let totalPortfolioValue = 0;

        if (allTokensForDisplay.length > 0) {
            html += `<div class="asset-column"><h4>${t.tokens_section_title}</h4><ul class="token-list">`;
            allTokensForDisplay.forEach(token => {
                const logoUrl = resolveIpfsUrl(token.assets?.svgUrl || token.assets?.pngUrl || '');
                const tokenBalance = parseFloat(token.balance) / (10 ** (token.decimals || 0));
                const priceData = prices[token.identifier];
                
                let specialIcon = '';
                if (token.iconType === 'home') {
                    specialIcon = '<span class="home-icon">üè†</span>';
                } else if (token.iconType === 'favorite') {
                    specialIcon = '<span class="favorite-icon">‚≠ê</span>';
                } else if (token.iconType === 'native') {
                    specialIcon = '<span class="native-icon">‚ö°</span>';
                }

                let priceHtml = '';
                if (priceData && priceData.usd !== undefined) {
                    const usdValue = tokenBalance * priceData.usd;
                    totalPortfolioValue += usdValue;
                    
                    const priceChangeClass = priceData.usd_24h_change >= 0 ? 'positive' : 'negative';
                    const priceChangeText = formatPriceChange(priceData.usd_24h_change);
                    
                    priceHtml = `
                        <div class="price-info">
                            <div class="price-usd">$${formatPrice(priceData.usd)}</div>
                            <div class="price-usd">$${formatPrice(usdValue)}</div>
                            ${priceChangeText ? `<div class="price-change ${priceChangeClass}">${priceChangeText}</div>` : ''}
                        </div>
                    `;
                } else {
                    priceHtml = `<div class="price-info"><div class="price-error">${t.price_unavailable}</div></div>`;
                }

                html += `<li>
                            <div class="asset-logo-container">
                                <img src="${logoUrl || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}"
                                     class="asset-logo" alt="${token.name || token.identifier}"
                                     onerror="this.parentElement.innerHTML = '<div class=&quot;asset-placeholder-logo&quot;>${(token.name || token.identifier).substring(0, 2).toUpperCase()}</div>';">
                            </div>
                            <div class="asset-info">
                                <div class="asset-details">
                                    <div class="asset-name">
                                        <a href="https://explorer.multiversx.com/tokens/${token.identifier}" target="_blank" rel="noopener noreferrer">${token.name || token.identifier} ‚Üó</a>
                                        ${specialIcon}
                                    </div>
                                    <div class="asset-balance">
                                        <span>${tokenBalance.toFixed(token.decimals > 4 ? 4 : token.decimals || 0)}</span>
                                    </div>
                                </div>
                                ${priceHtml}
                            </div>
                        </li>`;
            });
            html += `</ul>`;
            
            // Add total portfolio value
            if (totalPortfolioValue > 0) {
                html += `
                    <div class="total-value">
                        <h3>${t.total_portfolio_value}</h3>
                        <div class="amount">$${totalPortfolioValue.toFixed(2)}</div>
                    </div>
                `;
            }
            
            html += `</div>`;
        } else {
            html += `<div class="asset-column"><h4>${t.tokens_section_title}</h4><p>${t.no_tokens_message}</p></div>`;
        }
        
        const userNftsByCollection = {};
        nfts.forEach(nft => {
            const col = nft.collection;
            if (!userNftsByCollection[col]) {
                userNftsByCollection[col] = {
                    collectionId: col,
                    collectionName: nft.name?.split('-')[0].trim() || col,
                    count: 0,
                    logoUrl: resolveIpfsUrl(nft.media?.[0]?.url || nft.url)
                };
            }
            userNftsByCollection[col].count++;
        });

        const allCollections = Object.values(userNftsByCollection);
        const budIndex = allCollections.findIndex(c => c.collectionId === ebudsCollectionId);
        let allNftsForDisplay = [];

        if (budIndex > -1) {
            const budCollection = allCollections.splice(budIndex, 1)[0];
            budCollection.count = votePower;
